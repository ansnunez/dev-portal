<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Incremental DB · Zilliqa Developer Portal</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The incremental DB feature leverages on AWS Simple Storage Service (S3) to provide an efficient way for miners and seed nodes to get blockchain data in order to join the network."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Incremental DB · Zilliqa Developer Portal"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ansnunez.github.io/dev-portal/"/><meta property="og:description" content="The incremental DB feature leverages on AWS Simple Storage Service (S3) to provide an efficient way for miners and seed nodes to get blockchain data in order to join the network."/><meta property="og:image" content="https://ansnunez.github.io/dev-portal/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://ansnunez.github.io/dev-portal/img/docusaurus.png"/><link rel="shortcut icon" href="/dev-portal/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/dev-portal/js/scrollSpy.js"></script><link rel="stylesheet" href="/dev-portal/css/main.css"/><script src="/dev-portal/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/dev-portal/en"><img class="logo" src="/dev-portal/img/zilliqa-logo_1zilliqa-logo.png" alt="Zilliqa Developer Portal"/><h2 class="headerTitleWithLogo">Zilliqa Developer Portal</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/dev-portal/docs/en/basics-intro-blockchain" target="_self">Basics</a></li><li class=""><a href="/dev-portal/docs/en/dev-started-introduction" target="_self">Developers</a></li><li class=""><a href="/dev-portal/docs/en/mining-general-info" target="_self">Miners</a></li><li class=""><a href="/dev-portal/docs/en/staking-getting-started" target="_self">Exchanges</a></li><li class="siteNavGroupActive"><a href="/dev-portal/docs/en/contribute-buildzil" target="_self">Contributors</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/dev-portal/img/language.svg" alt="Languages icon"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/dev-portal/docs/zh-CN/core-incremental-db">中文</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Core Protocol Design</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Contributors</h3><ul class=""><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Contribution Guide</h4><ul><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/contribute-buildzil">Building Zilliqa</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/contribute-guidelines">Contribution Guidelines</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/contribute-bug-bounty">Bug Bounty Program</a></li></ul></div><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Core Protocol Design</h4><ul><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-node-operation">General Node Operation</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-consensus">Consensus</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-schnorr">Schnorr Algorithm</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-multisignatures">Multisignatures</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-gossip">Gossip</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-broadcasting">Broadcasting</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-blacklist">Blacklist</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-messaging-limits">Messaging Limits</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-message-processing">Message Processing</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-data">Data Layer</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-ds-mimo">DS MIMO</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-ds-reputation">DS Reputation</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-api-server">API Server</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-websocket-server">Websocket Server</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-transaction-dispatch">Transaction Dispatch</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-multipliers">Multipliers</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/dev-portal/docs/en/core-incremental-db">Incremental DB</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-mining">Mining</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-diagnostic-data">Diagnostic Data</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-view-change">View Change</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-guard-mode">Guard Mode</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-rejoin-mechanism">Rejoin Mechanism</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-recovery-mechanism">Recovery Mechanism</a></li><li class="navListItem"><a class="navItem" href="/dev-portal/docs/en/core-status-server">Status Server</a></li></ul></div></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Incremental DB</h1></header><article><div><span><p>The incremental DB feature leverages on AWS Simple Storage Service (S3) to provide an efficient way for miners and seed nodes to get blockchain data in order to join the network.</p>
<h2><a class="anchor" aria-hidden="true" id="background"></a><a href="#background" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Background</h2>
<p>Prior to this feature, the basic design involved uploading or syncing entire persistence to an AWS S3 bucket at each and every Tx epoch. New nodes would then fetch the entire persistence from that bucket.</p>
<p>This would have been alright for all existing LevelDB databases, with the exception of the <code>state</code> database. This is because running <code>aws-cli sync</code> on <code>state</code> results in uploading all files in the database, which is time-consuming and not bandwidth efficient.</p>
<p>Uploading of <code>state</code> LevelDB for every Tx epoch is thus a bottleneck, and so incremental DB was introduced as the solution.</p>
<blockquote>
<p>Note: It is practically possible that all files in <code>stateDB</code> get updated at every Tx epoch, if transactions in that particular epoch changed the states of addresses that somehow update TrieDB across all the files in <code>state</code> LevelDB.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="implementation"></a><a href="#implementation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementation</h2>
<p>Two scripts make up the building blocks for incremental DB.</p>
<h3><a class="anchor" aria-hidden="true" id="upload-incremental-db-script"></a><a href="#upload-incremental-db-script" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload Incremental DB Script</h3>
<p>The script <code>uploadIncrDB.py</code> runs on a lookup node managed by Zilliqa Research. It performs the following steps:</p>
<ol>
<li>Add <code>Lock</code> file to S3 bucket <strong>incremental</strong></li>
<li>Perform sync between local <code>persistence</code> folder (i.e., within this lookup node) and <code>incremental\persistence</code> on AWS S3 every Tx epoch. More specifically, syncing is done according to different criteria based on the Tx epoch number. These are the possibilities:</li>
</ol>
<ul>
<li>At script startup
<ol>
<li>Clear both buckets, i.e., <strong>incremental</strong> and <strong>statedelta</strong></li>
<li>Sync entire <code>persistence</code> (i.e., everything that exists in the folder, including <code>state</code>, <code>stateroot</code>, <code>txBlocks</code>, <code>txnBodies</code>, <code>txnBodiesTmp</code>, <code>microblock</code>, etc) to bucket <strong>incremental</strong></li>
<li>Clear all state deltas from bucket <strong>statedelta</strong></li>
</ol></li>
<li>At every 10th DS epoch (i.e., the first Tx epoch following the 10th DS epoch)
<ol>
<li>Sync entire <code>persistence</code> to bucket <strong>incremental</strong></li>
<li>Clear all state deltas from bucket <strong>statedelta</strong></li>
</ol></li>
<li>At all other Tx epochs
<ol>
<li>Sync entire <code>persistence</code> (excluding <code>state</code>, <code>stateroot</code>, <code>contractCode</code>, <code>contractStateData</code>, <code>contractStateIndex</code>) to bucket <strong>incremental</strong></li>
<li>For the first Tx block within the DS epoch (e.g., 100, 200, 300, ...), we don't need to upload state delta differences. Instead, the complete <code>stateDelta</code> LevelDB (composed as a tarball, e.g.,  <code>stateDelta_100.tar.gz</code>) is uploaded to S3 bucket <strong>statedelta</strong></li>
<li>For other Tx blocks, we upload the state delta differences (composed as tarballs, e.g., <code>stateDelta_101.tar.gz</code>, <code>stateDelta_102.tar.gz</code>, .... <code>stateDelta_199.tar.gz</code>) to S3 bucket <strong>statedelta</strong></li>
</ol></li>
</ul>
<ol>
<li>Remove <code>Lock</code> file from S3 bucket <strong>incremental</strong></li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="download-incremental-db-script"></a><a href="#download-incremental-db-script" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Download Incremental DB Script</h3>
<p>The script <code>downloadIncrDB.py</code> is executed upon startup by every miner or seed node to get the latest block chain data. It performs the following steps:</p>
<ol>
<li>Check if <code>Lock</code> file exists. Wait until no <code>Lock</code> file is found</li>
<li>Clear existing local <code>persistence</code> folder, then download entire persistence data (except <code>microblocks</code> and <code>txBodies</code> for miner nodes) from S3 bucket <strong>incremental</strong></li>
<li>Check if <code>Lock</code> file has appeared after executing the previous step. If yes, return to the first step</li>
<li>Clear existing local <code>StateDeltasFromS3</code> folder, then download all state deltas from S3 bucket <strong>statedelta</strong> to <code>StateDeltasFromS3</code> folder</li>
</ol>
<h2><a class="anchor" aria-hidden="true" id="incremental-db-usage-by-a-joining-node"></a><a href="#incremental-db-usage-by-a-joining-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Incremental DB Usage by a Joining Node</h2>
<ol>
<li>Node uses the <code>downloadIncrDB.py</code> script to populate its <code>persistence</code> folder from S3 bucket <strong>incrementalDB</strong></li>
<li>Node uses the same script to populate its <code>StateDeltasFromS3</code> folder with all the state deltas from S3 bucket <strong>statedelta</strong></li>
<li>Node loads the contents of <code>persistence</code> and initiates syncup. At this point, node has a base state of, say, <code>X</code></li>
<li>Node then recreates the latest state using the state deltas in <code>StateDeltasFromS3</code> (e.g. <code>stateDelta_101.tar.gz</code>, <code>stateDelta_101.tar.gz</code>, ...., <code>stateDelta_199.tar.gz</code>, <code>stateDelta_200.tar.gz</code>, <code>stateDelta_201.tar.gz</code>, ....)</li>
<li>Using these files, the final state <code>Y</code> is computed as <code>Y = X + x1 + x2 + ... + x99 + x100 + x101 + x102 + ...</code></li>
</ol>
<p>More information on new node joining can be found in the <a href="/dev-portal/docs/en/core-rejoin-mechanism">Rejoin Mechanism</a> page.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/dev-portal/docs/en/core-multipliers"><span class="arrow-prev">← </span><span>Multipliers</span></a><a class="docs-next button" href="/dev-portal/docs/en/core-mining"><span>Mining</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#background">Background</a></li><li><a href="#implementation">Implementation</a><ul class="toc-headings"><li><a href="#upload-incremental-db-script">Upload Incremental DB Script</a></li><li><a href="#download-incremental-db-script">Download Incremental DB Script</a></li></ul></li><li><a href="#incremental-db-usage-by-a-joining-node">Incremental DB Usage by a Joining Node</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/dev-portal/" class="nav-home"><img src="/dev-portal/img/zilliqa-logo_1zilliqa-logo.png" alt="Zilliqa Developer Portal" width="66" height="70"/></a><div><h5>Links</h5><a href="https://www.github.com/Zilliqa" target="_blank" rel="noreferrer noopener">GitHub</a><a href="https://blog.zilliqa.com/" target="_blank" rel="noreferrer noopener">Medium</a><a href="https://twitter.com/zilliqa" target="_blank" rel="noreferrer noopener">Twitter</a><a href="https://discord.gg/XMRE9tt" target="_blank" rel="noreferrer noopener">Discord</a><a href="https://www.youtube.com/channel/UCvinnFbf0u71cajoxKcfZIQ" target="_blank" rel="noreferrer noopener">YouTube</a></div></section><section class="copyright">Copyright © 2020 Zilliqa Research Pte. Ltd.</section></footer></div></body></html>